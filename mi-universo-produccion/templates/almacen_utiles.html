<div class="tab-header">
    <h2>üìö Control de √ötiles Escolares</h2>
    <p>Gestiona las listas de √∫tiles y el control de entregas por estudiante</p>
</div>

<div class="form-section">
    <h3>üè´ Configurar Lista de √ötiles por Aula</h3>
    <form class="config-form" id="utilesForm">
        <div class="form-row">
            <div class="form-group">
                <label>Aula</label>
                <select id="aulaSelect" required>
                    <option value="">Seleccionar aula</option>
                </select>
            </div>
           
            <div class="form-group">
                <label>Material</label>
                <input type="text" id="materialName" placeholder="Ej: Cuaderno cuadriculado, L√°pices 2B, etc." required>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label>Cantidad Requerida</label>
                <input type="number" id="cantidadRequerida" placeholder="Ej: 2, 5, etc." min="1" required>
            </div>
           
            <div class="form-group">
                <label>Especificaciones</label>
                <input type="text" id="especificaciones" placeholder="Ej: Tama√±o A4, Color azul, etc.">
            </div>
        </div>
       
        <div class="form-actions">
            <button type="submit" class="btn btn-success">‚ûï Agregar a Lista</button>
        </div>
    </form>
</div>

<div class="content-section">
    <h3>Lista de √ötiles Configurada</h3>
    <div class="form-group">
        <label>Seleccionar Aula para ver lista</label>
        <select id="aulaListaSelect" onchange="loadListaUtiles()">
            <option value="">Seleccionar aula</option>
        </select>
    </div>
    <div class="items-list" id="listaUtiles">
        <div class="empty-state">
            <div class="icon">üìö</div>
            <p>Selecciona un aula para ver la lista de √∫tiles</p>
        </div>
    </div>
</div>

<div class="content-section">
    <h3>üìä Control de Entregas por Estudiante</h3>
    <div class="form-group">
        <label>Seleccionar Aula para ver estudiantes</label>
        <select id="aulaEstudiantesSelect" onchange="loadControlEntregas()">
            <option value="">Seleccionar aula</option>
        </select>
    </div>
   
    <div id="controlEstudiantes">
        <div class="empty-state">
            <div class="icon">üë•</div>
            <p>Selecciona un aula para ver el control de entregas</p>
        </div>
    </div>
</div>

<script>
    // Cargar aulas en los select
    async function loadAulas() {
        try {
            const response = await fetch('/api/classrooms');
            const aulas = await response.json();
           
            const aulaSelect = document.getElementById('aulaSelect');
            const aulaListaSelect = document.getElementById('aulaListaSelect');
            const aulaEstudiantesSelect = document.getElementById('aulaEstudiantesSelect');
           
            // Limpiar selects
            aulaSelect.innerHTML = '<option value="">Seleccionar aula</option>';
            aulaListaSelect.innerHTML = '<option value="">Seleccionar aula</option>';
            aulaEstudiantesSelect.innerHTML = '<option value="">Seleccionar aula</option>';
           
            aulas.forEach(aula => {
                const option1 = new Option(aula.name, aula.id);
                const option2 = new Option(aula.name, aula.id);
                const option3 = new Option(aula.name, aula.id);
                aulaSelect.add(option1);
                aulaListaSelect.add(option2);
                aulaEstudiantesSelect.add(option3);
            });
        } catch (error) {
            console.log('Error cargando aulas:', error);
        }
    }
   
    // Cargar lista de √∫tiles
    async function loadListaUtiles() {
        try {
            const aulaId = document.getElementById('aulaListaSelect').value;
            if (!aulaId) return;
           
            const response = await fetch(`/api/almacen/utiles?aula_id=${aulaId}`);
            const utiles = await response.json();
           
            const listaUtiles = document.getElementById('listaUtiles');
           
            if (utiles.length === 0) {
                listaUtiles.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìö</div>
                        <p>No hay √∫tiles configurados para esta aula</p>
                    </div>
                `;
                return;
            }
           
            let html = '';
            utiles.forEach(util => {
                html += `
                    <div class="list-item">
                        <div class="list-item-content">
                            <h4>${util.material}</h4>
                            <p>Cantidad requerida: ${util.cantidad_requerida}</p>
                            <small>Especificaciones: ${util.especificaciones || 'No especificado'}</small>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-danger" onclick="eliminarUtil(${util.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
            });
           
            listaUtiles.innerHTML = html;
        } catch (error) {
            console.log('Error cargando lista de √∫tiles:', error);
        }
    }
   
    // Guardar √∫til en la lista
    document.getElementById('utilesForm').addEventListener('submit', async function(e) {
        e.preventDefault();
       
        const utilData = {
            aula_id: document.getElementById('aulaSelect').value,
            material: document.getElementById('materialName').value,
            cantidad_requerida: parseInt(document.getElementById('cantidadRequerida').value),
            especificaciones: document.getElementById('especificaciones').value
        };
       
        try {
            const response = await fetch('/api/almacen/utiles', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(utilData)
            });
           
            const result = await response.json();
           
            if (result.success) {
                alert('‚úÖ Material agregado a la lista');
                loadListaUtiles();
                document.getElementById('utilesForm').reset();
            } else {
                alert('‚ùå ' + result.error);
            }
        } catch (error) {
            alert('‚ùå Error al agregar material');
        }
    });
   
    // Cargar control de entregas
    async function loadControlEntregas() {
        const aulaId = document.getElementById('aulaEstudiantesSelect').value;
        if (!aulaId) return;
       
        try {
            const response = await fetch(`/api/almacen/entregas/${aulaId}`);
            const data = await response.json();
           
            const controlEstudiantes = document.getElementById('controlEstudiantes');
           
            if (data.estudiantes.length === 0) {
                controlEstudiantes.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <p>No hay estudiantes matriculados en esta aula</p>
                    </div>
                `;
                return;
            }
           
            let html = '<div class="entregas-grid">';
           
            data.estudiantes.forEach(estudiante => {
                html += `
                    <div class="estudiante-card">
                        <div class="estudiante-header">
                            <div class="estudiante-info">
                                <h4>${estudiante.nombre}</h4>
                                <small>DNI: ${estudiante.dni}</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="imprimirReporteUtiles(${estudiante.id}, '${estudiante.nombre}', '${estudiante.dni}')">
                                üñ®Ô∏è Imprimir Reporte
                            </button>
                        </div>
                        <div class="utiles-lista">
                `;
               
                data.utiles.forEach(util => {
                    const entrega = data.entregas.find(e =>
                        e.estudiante_id === estudiante.id && e.util_id === util.id
                    );
                    const entregado = entrega ? entrega.cantidad_entregada : 0;
                    const pendiente = util.cantidad_requerida - entregado;
                   
                    html += `
                        <div class="util-item">
                            <span class="util-nombre">${util.material}</span>
                            <span class="util-cantidad">
                                ${entregado}/${util.cantidad_requerida}
                                ${pendiente > 0 ? `<span class="pendiente">(Faltan ${pendiente})</span>` : `<span class="completo">‚úì Completo</span>`}
                            </span>
                            <button class="btn btn-sm btn-outline" onclick="registrarEntrega(${estudiante.id}, ${util.id}, ${util.cantidad_requerida})">
                                üìù Registrar
                            </button>
                        </div>
                    `;
                });
               
                html += `
                        </div>
                    </div>
                `;
            });
           
            html += '</div>';
            controlEstudiantes.innerHTML = html;
           
        } catch (error) {
            console.log('Error cargando control de entregas:', error);
            controlEstudiantes.innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚ùå</div>
                    <p>Error al cargar el control de entregas</p>
                </div>
            `;
        }
    }

    // Imprimir reporte de √∫tiles del alumno
    async function imprimirReporteUtiles(estudianteId, estudianteNombre, estudianteDNI) {
        const aulaId = document.getElementById('aulaEstudiantesSelect').value;
        if (!aulaId) {
            alert('‚ùå Primero selecciona un aula');
            return;
        }

        try {
            // Obtener datos actualizados de la API
            const response = await fetch(`/api/almacen/entregas/${aulaId}`);
            const data = await response.json();
            
            // Encontrar el estudiante espec√≠fico
            const estudianteData = data.estudiantes.find(e => e.id === estudianteId);
            const entregasEstudiante = data.entregas.filter(e => e.estudiante_id === estudianteId);

            if (!estudianteData) {
                alert('‚ùå No se encontraron datos del estudiante');
                return;
            }

            // Crear ventana de impresi√≥n
            const ventanaImpresion = window.open('', '_blank', 'width=900,height=700');
            
            let contenidoHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Reporte de √ötiles - ${estudianteNombre}</title>
                    <style>
                        body { 
                            font-family: 'Segoe UI', Arial, sans-serif; 
                            margin: 30px; 
                            background: white;
                            color: #333;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 3px solid #2563eb; 
                            padding-bottom: 20px;
                        }
                        .header h1 { 
                            color: #2563eb; 
                            margin: 0; 
                            font-size: 28px;
                        }
                        .header h2 {
                            color: #64748b;
                            margin: 5px 0 0 0;
                            font-size: 18px;
                            font-weight: normal;
                        }
                        .info-alumno { 
                            background: #f8fafc; 
                            padding: 20px; 
                            border-radius: 10px; 
                            margin: 20px 0; 
                            border-left: 4px solid #2563eb;
                        }
                        .info-alumno h3 {
                            color: #2563eb;
                            margin-top: 0;
                            border-bottom: 2px solid #e2e8f0;
                            padding-bottom: 10px;
                        }
                        .tabla-utiles { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 25px 0; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            border-radius: 10px;
                            overflow: hidden;
                        }
                        .tabla-utiles th { 
                            background: #2563eb; 
                            color: white; 
                            padding: 15px; 
                            text-align: left; 
                            font-weight: 600;
                        }
                        .tabla-utiles td { 
                            border: 1px solid #e2e8f0; 
                            padding: 12px 15px; 
                            text-align: left; 
                        }
                        .tabla-utiles tr:nth-child(even) {
                            background: #f8fafc;
                        }
                        .completo { 
                            color: #10b981; 
                            font-weight: bold; 
                        }
                        .pendiente { 
                            color: #ef4444; 
                            font-weight: bold; 
                        }
                        .fecha { 
                            text-align: right; 
                            color: #64748b; 
                            margin-top: 40px; 
                            font-style: italic;
                        }
                        .estado-badge {
                            padding: 4px 8px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .estado-completo {
                            background: #d1fae5;
                            color: #065f46;
                        }
                        .estado-pendiente {
                            background: #fef3c7;
                            color: #92400e;
                        }
                        @media print {
                            .no-print { display: none; }
                            body { margin: 15px; }
                            .tabla-utiles { box-shadow: none; }
                        }
                        .resumen {
                            background: #f0f9ff;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 20px 0;
                            border: 1px solid #bae6fd;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìö Reporte de √ötiles Escolares</h1>
                        <h2>Mi Peque√±o Universo</h2>
                    </div>
                    
                    <div class="info-alumno">
                        <h3>üë§ Datos del Alumno</h3>
                        <p><strong>Nombre:</strong> ${estudianteNombre}</p>
                        <p><strong>DNI:</strong> ${estudianteDNI}</p>
                        <p><strong>Aula:</strong> ${document.getElementById('aulaEstudiantesSelect').selectedOptions[0].text}</p>
                        <p><strong>Fecha de Reporte:</strong> ${new Date().toLocaleDateString('es-PE', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                    </div>
                    
                    <div class="resumen">
                        <h4>üìä Resumen de Entregas</h4>
                        <p>Total de materiales: ${data.utiles.length}</p>
                    </div>
                    
                    <table class="tabla-utiles">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Cantidad Requerida</th>
                                <th>Entregado</th>
                                <th>Pendiente</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Procesar cada √∫til
            let totalCompletos = 0;
            let totalPendientes = 0;

            data.utiles.forEach(util => {
                const entrega = entregasEstudiante.find(e => e.util_id === util.id);
                const entregado = entrega ? entrega.cantidad_entregada : 0;
                const pendiente = util.cantidad_requerida - entregado;
                const estado = pendiente === 0 ? 'Completo' : 'Pendiente';
                
                if (estado === 'Completo') totalCompletos++;
                else totalPendientes++;

                contenidoHTML += `
                    <tr>
                        <td>${util.material}</td>
                        <td>${util.cantidad_requerida}</td>
                        <td>${entregado}</td>
                        <td>${pendiente > 0 ? pendiente : '0'}</td>
                        <td>
                            <span class="estado-badge ${estado === 'Completo' ? 'estado-completo' : 'estado-pendiente'}">
                                ${estado}
                            </span>
                        </td>
                    </tr>
                `;
            });

            contenidoHTML += `
                        </tbody>
                    </table>
                    
                    <div class="resumen">
                        <h4>üìà Estad√≠sticas</h4>
                        <p><strong>Materiales completos:</strong> ${totalCompletos}</p>
                        <p><strong>Materiales pendientes:</strong> ${totalPendientes}</p>
                        <p><strong>Progreso general:</strong> ${Math.round((totalCompletos / data.utiles.length) * 100)}%</p>
                    </div>
                    
                    <div class="fecha">
                        <p>Reporte generado el: ${new Date().toLocaleString('es-PE')}</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button onclick="window.print()" style="padding: 12px 25px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;">
                            üñ®Ô∏è Imprimir Reporte
                        </button>
                        <button onclick="window.close()" style="padding: 12px 25px; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üìã Cerrar Ventana
                        </button>
                    </div>
                </body>
                </html>
            `;

            ventanaImpresion.document.write(contenidoHTML);
            ventanaImpresion.document.close();
            
        } catch (error) {
            console.error('Error generando reporte:', error);
            alert('‚ùå Error al generar el reporte');
        }
    }
   
    // Registrar entrega
    async function registrarEntrega(estudianteId, utilId, cantidadRequerida) {
        const cantidad = prompt(`Ingrese la cantidad entregada (requerido: ${cantidadRequerida}):`);
       
        if (cantidad && !isNaN(cantidad) && parseInt(cantidad) > 0) {
            try {
                const entregaData = {
                    estudiante_id: estudianteId,
                    util_id: utilId,
                    cantidad_entregada: parseInt(cantidad)
                };
               
                const response = await fetch('/api/almacen/entregas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(entregaData)
                });
               
                const result = await response.json();
               
                if (result.success) {
                    alert('‚úÖ Entrega registrada correctamente');
                    loadControlEntregas();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error al registrar entrega');
            }
        }
    }
   
    // Eliminar √∫til
    async function eliminarUtil(id) {
        if (confirm('¬øEst√°s seguro de eliminar este material de la lista?')) {
            try {
                const response = await fetch(`/api/almacen/utiles/${id}`, {
                    method: 'DELETE'
                });
               
                const result = await response.json();
               
                if (result.success) {
                    alert('‚úÖ Material eliminado correctamente');
                    loadListaUtiles();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error al eliminar material');
            }
        }
    }
   
    // Inicializar
    document.getElementById('aulaSelect').addEventListener('change', loadListaUtiles);
    loadAulas();
</script>

<style>
.entregas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
.estudiante-card {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.estudiante-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
.estudiante-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f1f5f9;
}
.estudiante-info h4 {
    margin: 0 0 5px 0;
    color: #1e293b;
    font-size: 1.1rem;
}
.estudiante-info small {
    color: #64748b;
    font-size: 0.85rem;
}
.utiles-lista {
    margin-top: 15px;
}
.util-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f8fafc;
}
.util-item:last-child {
    border-bottom: none;
}
.util-nombre {
    flex: 2;
    font-size: 0.9rem;
    font-weight: 500;
    color: #374151;
}
.util-cantidad {
    flex: 1;
    text-align: center;
    font-size: 0.85rem;
    font-weight: 500;
}
.pendiente {
    color: #ef4444;
    font-weight: bold;
    font-size: 0.8rem;
}
.completo {
    color: #10b981;
    font-weight: bold;
    font-size: 0.8rem;
}
.btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
}
</style>