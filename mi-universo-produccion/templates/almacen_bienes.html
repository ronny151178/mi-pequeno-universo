<div class="tab-header">
    <h2>ü™ë Bienes del Aula</h2>
    <p>Inventario y control de mobiliario, equipos y bienes permanentes del aula</p>
</div>

<!-- Registro de Bienes -->
<div class="form-section">
    <h3>‚ûï Registrar Nuevo Bien</h3>
    <form class="config-form" id="bienForm">
        <div class="form-row">
            <div class="form-group">
                <label for="codigoPatrimonial">C√≥digo Patrimonial</label>
                <input type="text" id="codigoPatrimonial" class="form-control" placeholder="Ej: PAT-2024-001">
            </div>
           
            <div class="form-group">
                <label for="bienNombre">Nombre del Bien</label>
                <input type="text" id="bienNombre" class="form-control" placeholder="Ej: Silla estudiantil, Mesa rectangular, etc." required>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label for="bienCategoria">Categor√≠a</label>
                <select id="bienCategoria" class="form-control" required>
                    <option value="">Seleccionar categor√≠a</option>
                    <option value="mobiliario">Mobiliario</option>
                    <option value="equipo_tecnologico">Equipo Tecnol√≥gico</option>
                    <option value="material_educativo">Material Educativo</option>
                    <option value="herramientas">Herramientas</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
           
            <div class="form-group">
                <label for="bienEstado">Estado</label>
                <select id="bienEstado" class="form-control" required>
                    <option value="bueno">Bueno</option>
                    <option value="regular">Regular</option>
                    <option value="malo">Malo</option>
                    <option value="reparacion">En Reparaci√≥n</option>
                    <option value="baja">Dado de Baja</option>
                </select>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label for="bienMarca">Marca</label>
                <input type="text" id="bienMarca" class="form-control" placeholder="Ej: HP, Dell, etc.">
            </div>
           
            <div class="form-group">
                <label for="bienModelo">Modelo</label>
                <input type="text" id="bienModelo" class="form-control" placeholder="Ej: ProBook 450, etc.">
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label for="numeroSerie">N√∫mero de Serie</label>
                <input type="text" id="numeroSerie" class="form-control" placeholder="Ej: SN123456789">
            </div>
           
            <div class="form-group">
                <label for="bienAula">Aula Asignada</label>
                <select id="bienAula" class="form-control">
                    <option value="">Sin asignar</option>
                </select>
            </div>
        </div>
       
        <div class="form-row">
            <div class="form-group">
                <label for="fechaAdquisicion">Fecha de Adquisici√≥n</label>
                <input type="date" id="fechaAdquisicion" class="form-control">
            </div>
           
            <div class="form-group">
                <label for="valorAdquisicion">Valor de Adquisici√≥n (S/)</label>
                <input type="number" id="valorAdquisicion" class="form-control" placeholder="0.00" min="0" step="0.01">
            </div>
        </div>
       
        <div class="form-group">
            <label for="bienUbicacion">Ubicaci√≥n Espec√≠fica</label>
            <input type="text" id="bienUbicacion" class="form-control" placeholder="Ej: Frente al escritorio, Estante superior, etc.">
        </div>
       
        <div class="form-group">
            <label for="bienProveedor">Proveedor</label>
            <input type="text" id="bienProveedor" class="form-control" placeholder="Ej: Empresa XYZ">
        </div>
       
        <div class="form-group">
            <label for="bienDescripcion">Descripci√≥n</label>
            <textarea id="bienDescripcion" class="form-control" placeholder="Descripci√≥n detallada del bien..." rows="3"></textarea>
        </div>
       
        <div class="form-group">
            <label for="bienObservaciones">Observaciones</label>
            <textarea id="bienObservaciones" class="form-control" placeholder="Observaciones adicionales..." rows="2"></textarea>
        </div>
       
        <div class="form-actions">
            <button type="submit" class="btn btn-success">üíæ Guardar Bien</button>
        </div>
    </form>
</div>

<!-- Lista de Bienes -->
<div class="content-section">
    <h3>üìã Inventario de Bienes</h3>
    <div class="items-list" id="listaBienes">
        <div class="empty-state">
            <div class="icon">ü™ë</div>
            <p>No hay bienes registrados</p>
        </div>
    </div>
</div>

<!-- Mantenimientos de Bienes -->
<div class="content-section">
    <h3>üîß Historial de Mantenimientos</h3>
    <div class="form-group">
        <label for="bienMantenimientosSelect">Seleccionar Bien para ver mantenimientos</label>
        <select id="bienMantenimientosSelect" class="form-control" onchange="cargarMantenimientos()">
            <option value="">Seleccionar bien</option>
        </select>
    </div>
   
    <div id="seccionMantenimientos" style="display: none;">
        <div class="form-section">
            <h4>üõ†Ô∏è Registrar Nuevo Mantenimiento</h4>
            <form class="config-form" id="mantenimientoForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipoMantenimiento">Tipo de Mantenimiento</label>
                        <select id="tipoMantenimiento" class="form-control" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="preventivo">Preventivo</option>
                            <option value="correctivo">Correctivo</option>
                        </select>
                    </div>
                   
                    <div class="form-group">
                        <label for="fechaMantenimiento">Fecha de Mantenimiento</label>
                        <input type="date" id="fechaMantenimiento" class="form-control" required>
                    </div>
                </div>
               
                <div class="form-row">
                    <div class="form-group">
                        <label for="costoMantenimiento">Costo (S/)</label>
                        <input type="number" id="costoMantenimiento" class="form-control" placeholder="0.00" min="0" step="0.01">
                    </div>
                   
                    <div class="form-group">
                        <label for="proveedorMantenimiento">Proveedor del Mantenimiento</label>
                        <input type="text" id="proveedorMantenimiento" class="form-control" placeholder="Ej: Taller t√©cnico XYZ">
                    </div>
                </div>
               
                <div class="form-group">
                    <label for="descripcionMantenimiento">Descripci√≥n del Mantenimiento</label>
                    <textarea id="descripcionMantenimiento" class="form-control" placeholder="Describa el trabajo realizado..." required rows="3"></textarea>
                </div>
               
                <div class="form-group">
                    <label for="observacionesMantenimiento">Observaciones</label>
                    <textarea id="observacionesMantenimiento" class="form-control" placeholder="Observaciones adicionales..." rows="2"></textarea>
                </div>
               
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üîß Registrar Mantenimiento</button>
                </div>
            </form>
        </div>
       
        <div class="content-section">
            <h4>üìä Historial de Mantenimientos</h4>
            <div class="items-list" id="historialMantenimientos">
                <div class="empty-state">
                    <div class="icon">üîß</div>
                    <p>No hay mantenimientos registrados</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Cargar aulas para el select
    async function cargarAulasBienes() {
        try {
            const response = await fetch('/api/classrooms');
            const aulas = await response.json();
           
            const selectAula = document.getElementById('bienAula');
            selectAula.innerHTML = '<option value="">Sin asignar</option>';
           
            aulas.forEach(aula => {
                const option = new Option(aula.name, aula.id);
                selectAula.add(option);
            });
        } catch (error) {
            console.log('Error cargando aulas:', error);
        }
    }
   
    // Cargar bienes
    async function cargarBienes() {
        try {
            const response = await fetch('/api/almacen/bienes');
            const bienes = await response.json();
           
            const listaBienes = document.getElementById('listaBienes');
            const selectMantenimientos = document.getElementById('bienMantenimientosSelect');
           
            // Limpiar selects
            selectMantenimientos.innerHTML = '<option value="">Seleccionar bien</option>';
           
            if (bienes.length === 0) {
                listaBienes.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ü™ë</div>
                        <p>No hay bienes registrados</p>
                    </div>
                `;
                return;
            }
           
            let html = '';
            bienes.forEach(bien => {
                // Determinar clase de estado
                let estadoClass = 'estado-bueno';
                let estadoIcon = '‚úÖ';
               
                if (bien.estado === 'regular') {
                    estadoClass = 'estado-regular';
                    estadoIcon = '‚ö†Ô∏è';
                } else if (bien.estado === 'malo') {
                    estadoClass = 'estado-malo';
                    estadoIcon = '‚ùå';
                } else if (bien.estado === 'reparacion') {
                    estadoClass = 'estado-reparacion';
                    estadoIcon = 'üîß';
                } else if (bien.estado === 'baja') {
                    estadoClass = 'estado-baja';
                    estadoIcon = 'üóëÔ∏è';
                }
               
                html += `
                    <div class="list-item">
                        <div class="list-item-content">
                            <h4>${bien.nombre} ${bien.codigo_patrimonial ? `(${bien.codigo_patrimonial})` : ''}</h4>
                            <p>Categor√≠a: ${bien.categoria} | Marca: ${bien.marca || 'No especificada'} | Modelo: ${bien.modelo || 'No especificado'}</p>
                            <div class="bien-info">
                                <span class="${estadoClass}">${estadoIcon} ${bien.estado.toUpperCase()}</span>
                                <span>Ubicaci√≥n: ${bien.ubicacion || 'No especificada'}</span>
                                <span>Aula: ${bien.aula_nombre || 'Sin asignar'}</span>
                            </div>
                            <small>N¬∞ Serie: ${bien.numero_serie || 'No especificado'} | Adquisici√≥n: ${bien.fecha_adquisicion || 'No especificada'}</small>
                        </div>
                        <div class="list-item-actions">
                            <button class="btn btn-sm btn-outline" onclick="editarBien(${bien.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarBien(${bien.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
               
                // Agregar al select de mantenimientos
                const option = new Option(`${bien.nombre} ${bien.codigo_patrimonial ? `(${bien.codigo_patrimonial})` : ''}`, bien.id);
                selectMantenimientos.add(option);
            });
           
            listaBienes.innerHTML = html;
        } catch (error) {
            console.log('Error cargando bienes:', error);
        }
    }
   
    // Guardar bien
    document.getElementById('bienForm').addEventListener('submit', async function(e) {
        e.preventDefault();
       
        const bienData = {
            codigo_patrimonial: document.getElementById('codigoPatrimonial').value || null,
            nombre: document.getElementById('bienNombre').value,
            categoria: document.getElementById('bienCategoria').value,
            estado: document.getElementById('bienEstado').value,
            marca: document.getElementById('bienMarca').value,
            modelo: document.getElementById('bienModelo').value,
            numero_serie: document.getElementById('numeroSerie').value,
            aula_id: document.getElementById('bienAula').value || null,
            ubicacion: document.getElementById('bienUbicacion').value,
            fecha_adquisicion: document.getElementById('fechaAdquisicion').value,
            valor_adquisicion: document.getElementById('valorAdquisicion').value ? parseFloat(document.getElementById('valorAdquisicion').value) : null,
            proveedor: document.getElementById('bienProveedor').value,
            descripcion: document.getElementById('bienDescripcion').value,
            observaciones: document.getElementById('bienObservaciones').value
        };
       
        try {
            const response = await fetch('/api/almacen/bienes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bienData)
            });
           
            const result = await response.json();
           
            if (result.success) {
                alert('‚úÖ Bien guardado correctamente');
                cargarBienes();
                document.getElementById('bienForm').reset();
            } else {
                alert('‚ùå ' + result.error);
            }
        } catch (error) {
            alert('‚ùå Error al guardar bien');
        }
    });
   
    // Cargar mantenimientos
    async function cargarMantenimientos() {
        const bienId = document.getElementById('bienMantenimientosSelect').value;
        if (!bienId) {
            document.getElementById('seccionMantenimientos').style.display = 'none';
            return;
        }
       
        document.getElementById('seccionMantenimientos').style.display = 'block';
       
        try {
            const response = await fetch(`/api/almacen/bienes/${bienId}/mantenimientos`);
            const mantenimientos = await response.json();
           
            const historialMantenimientos = document.getElementById('historialMantenimientos');
           
            if (mantenimientos.length === 0) {
                historialMantenimientos.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîß</div>
                        <p>No hay mantenimientos registrados</p>
                    </div>
                `;
                return;
            }
           
            let html = '';
            mantenimientos.forEach(mant => {
                const tipoIcon = mant.tipo_mantenimiento === 'preventivo' ? 'üõ°Ô∏è' : 'üîß';
                const tipoClass = mant.tipo_mantenimiento === 'preventivo' ? 'mant-preventivo' : 'mant-correctivo';
               
                html += `
                    <div class="list-item">
                        <div class="list-item-content">
                            <h4><span class="${tipoClass}">${tipoIcon} ${mant.tipo_mantenimiento.toUpperCase()}</span></h4>
                            <p>${mant.descripcion}</p>
                            <div class="mant-info">
                                <span>Fecha: ${mant.fecha_mantenimiento}</span>
                                <span>Costo: S/ ${mant.costo || '0.00'}</span>
                                <span>Proveedor: ${mant.proveedor_mantenimiento || 'No especificado'}</span>
                            </div>
                            ${mant.observaciones ? `<p><em>Observaciones: ${mant.observaciones}</em></p>` : ''}
                        </div>
                    </div>
                `;
            });
           
            historialMantenimientos.innerHTML = html;
        } catch (error) {
            console.log('Error cargando mantenimientos:', error);
        }
    }
   
    // Registrar mantenimiento
    document.getElementById('mantenimientoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
       
        const bienId = document.getElementById('bienMantenimientosSelect').value;
        if (!bienId) {
            alert('‚ùå Debes seleccionar un bien');
            return;
        }
       
        const mantenimientoData = {
            tipo_mantenimiento: document.getElementById('tipoMantenimiento').value,
            fecha_mantenimiento: document.getElementById('fechaMantenimiento').value,
            descripcion: document.getElementById('descripcionMantenimiento').value,
            costo: document.getElementById('costoMantenimiento').value ? parseFloat(document.getElementById('costoMantenimiento').value) : 0,
            proveedor_mantenimiento: document.getElementById('proveedorMantenimiento').value,
            observaciones: document.getElementById('observacionesMantenimiento').value
        };
       
        try {
            const response = await fetch(`/api/almacen/bienes/${bienId}/mantenimientos`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(mantenimientoData)
            });
           
            const result = await response.json();
           
            if (result.success) {
                alert('‚úÖ Mantenimiento registrado correctamente');
                document.getElementById('mantenimientoForm').reset();
                cargarMantenimientos();
            } else {
                alert('‚ùå ' + result.error);
            }
        } catch (error) {
            alert('‚ùå Error al registrar mantenimiento');
        }
    });
   
    // Funciones de edici√≥n y eliminaci√≥n
    async function editarBien(id) {
        alert('Funcionalidad de edici√≥n en desarrollo para bien ID: ' + id);
    }
   
    async function eliminarBien(id) {
        if (confirm('¬øEst√°s seguro de eliminar este bien?')) {
            try {
                const response = await fetch(`/api/almacen/bienes/${id}`, {
                    method: 'DELETE'
                });
               
                const result = await response.json();
               
                if (result.success) {
                    alert('‚úÖ Bien eliminado correctamente');
                    cargarBienes();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error al eliminar bien');
            }
        }
    }
   
    // Inicializar
    cargarAulasBienes();
    cargarBienes();
</script>

<style>
.bien-info {
    display: flex;
    gap: 15px;
    margin: 8px 0;
    flex-wrap: wrap;
}
.bien-info span {
    font-size: 0.85rem;
    color: #64748b;
}
.mant-info {
    display: flex;
    gap: 15px;
    margin: 8px 0;
    flex-wrap: wrap;
}
.mant-info span {
    font-size: 0.85rem;
    color: #64748b;
}
/* Estados de bienes */
.estado-bueno {
    color: #10b981;
    font-weight: bold;
}
.estado-regular {
    color: #f59e0b;
    font-weight: bold;
}
.estado-malo {
    color: #ef4444;
    font-weight: bold;
}
.estado-reparacion {
    color: #8b5cf6;
    font-weight: bold;
}
.estado-baja {
    color: #6b7280;
    font-weight: bold;
}
/* Tipos de mantenimiento */
.mant-preventivo {
    color: #10b981;
    font-weight: bold;
}
.mant-correctivo {
    color: #f59e0b;
    font-weight: bold;
}
</style>