<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matr√≠culas - Mi Peque√±o Universo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
            <span>Mi Peque√±o Universo</span>
        </div>
        <div class="user-menu">Administrador üë§</div>
    </div>
    
    <div class="main-grid">
        <div class="sidebar">
            <a href="/dashboard">üìä Dashboard</a>
            <a href="/config-a√±o">üìÖ A√±o Escolar</a>
            <a href="/config-aulas">üè´ Aulas</a>
            <a href="/config-conceptos">üí∞ Conceptos</a>
            <a href="/estudiantes">üë• Estudiantes</a>
            <a href="/matriculas" class="active">üéì Matr√≠culas</a>
            <a href="/pagos">üí≥ Pagos</a>
            <a href="/planes-pago">üìÖ Planes de Pago</a>
            <a href="/almacen">üì¶ Almac√©n</a>
            <a href="/reportes">üìä Reportes</a>
            <a href="/api/logout">üö™ Salir</a>
        </div>
        
        <div class="content">
            <!-- FORMULARIO DE MATR√çCULA -->
            <div class="card" id="enrollmentFormCard">
                <h2>üéì <span id="enrollmentFormTitle">Nueva Matr√≠cula</span></h2>
                <form id="enrollmentForm">
                    <input type="hidden" id="enrollmentId" value="">
                    
                    <div class="form-group">
                        <label for="studentSelect">Estudiante *</label>
                        <select id="studentSelect" required>
                            <option value="">Seleccionar estudiante...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="classroomSelect">Aula *</label>
                        <select id="classroomSelect" required>
                            <option value="">Seleccionar aula...</option>
                        </select>
                        <div class="form-text" id="classroomInfo"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="enrollmentDate">Fecha de Matr√≠cula *</label>
                        <input type="date" id="enrollmentDate" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="cancelEdit()" id="cancelButton" style="display: none;">‚ùå Cancelar</button>
                        <button type="submit" class="btn btn-success" id="submitEnrollmentButton">‚úÖ Registrar Matr√≠cula</button>
                    </div>
                </form>
            </div>
            
            <!-- LISTA DE MATR√çCULAS -->
            <div class="card">
                <h2>üìã Matr√≠culas Activas</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>DNI</th>
                                <th>Aula</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="enrollmentsTable">
                            <!-- Las matr√≠culas se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isEditingEnrollment = false;
        let currentEnrollmentId = null;

        // Cargar estudiantes no matriculados
        async function loadUnenrolledStudents() {
            try {
                const response = await fetch('/api/students/unenrolled');
                const students = await response.json();
                
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">Seleccionar estudiante...</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.first_name} ${student.last_name} (DNI: ${student.dni}) - ${student.age} a√±os`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
            }
        }

        // Cargar aulas disponibles
        async function loadAvailableClassrooms() {
            try {
                const response = await fetch('/api/classrooms/available');
                const classrooms = await response.json();
                
                const select = document.getElementById('classroomSelect');
                select.innerHTML = '<option value="">Seleccionar aula...</option>';
                
                classrooms.forEach(classroom => {
                    if (classroom.available_spots > 0) {
                        const option = document.createElement('option');
                        option.value = classroom.id;
                        option.textContent = `${classroom.name} (${classroom.age_range}) - ${classroom.available_spots} cupos disponibles`;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error cargando aulas:', error);
            }
        }

        // Cargar todas las aulas (para edici√≥n)
        async function loadAllClassrooms() {
            try {
                const response = await fetch('/api/classrooms');
                const classrooms = await response.json();
                
                const select = document.getElementById('classroomSelect');
                select.innerHTML = '<option value="">Seleccionar aula...</option>';
                
                classrooms.forEach(classroom => {
                    const option = document.createElement('option');
                    option.value = classroom.id;
                    option.textContent = `${classroom.name} (${classroom.age_range})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando aulas:', error);
            }
        }

        // Cargar matr√≠culas
async function loadEnrollments() {
    try {
        const response = await fetch('/api/enrollments');
        const enrollments = await response.json();
        
        const tbody = document.getElementById('enrollmentsTable');
        
        // FILTRAR SOLO MATR√çCULAS ACTIVAS
        const activeEnrollments = enrollments.filter(e => e.status === 'active');
        
        if (activeEnrollments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No hay matr√≠culas activas</td></tr>';
            return;
        }
        
        let html = '';
        activeEnrollments.forEach(enrollment => {
            // Formatear fecha directamente
            const fecha = enrollment.enrollment_date.split('-').reverse().join('/');
            
            html += `
                <tr>
                    <td><strong>${enrollment.student_name}</strong></td>
                    <td>${enrollment.student_dni}</td>
                    <td>${enrollment.classroom_name}</td>
                    <td>${fecha}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewEnrollment(${enrollment.id})">üëÄ Ver</button>
                        <button class="btn btn-outline btn-sm" onclick="editEnrollment(${enrollment.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelEnrollment(${enrollment.id})">‚ùå Anular</button>
                        <button class="btn btn-sm" onclick="generateCertificate(${enrollment.id})">üñ®Ô∏è Constancia</button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    } catch (error) {
        console.error('Error cargando matr√≠culas:', error);
        document.getElementById('enrollmentsTable').innerHTML = 
            '<tr><td colspan="5">Error al cargar matr√≠culas</td></tr>';
    }
}

        // Ver matr√≠cula
        async function viewEnrollment(enrollmentId) {
            try {
                const response = await fetch(`/api/enrollments/${enrollmentId}/details`);
                const result = await response.json();
                
                if (result.success) {
                    const enrollment = result.enrollment;
                    const fecha = enrollment.enrollment_date.split('-').reverse().join('/');
                    
                    const enrollmentInfo = `
üéì INFORMACI√ìN DE MATR√çCULA:

üë§ ESTUDIANTE: ${enrollment.student_name}
üÜî DNI: ${enrollment.student_dni}
üè´ AULA: ${enrollment.classroom_name}
üìÖ FECHA MATR√çCULA: ${fecha}
üìã ESTADO: ${enrollment.status}
                    `;
                    
                    alert(enrollmentInfo);
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al cargar informaci√≥n de la matr√≠cula');
            }
        }

        // Editar matr√≠cula
        // Editar matr√≠cula
async function editEnrollment(enrollmentId) {
    try {
        const response = await fetch(`/api/enrollments/${enrollmentId}/edit`);
        const result = await response.json();
        
        if (result.success) {
            const enrollment = result.enrollment;
            
            // Llenar formulario con datos de la matr√≠cula
            document.getElementById('enrollmentId').value = enrollment.id;
            document.getElementById('enrollmentDate').value = enrollment.enrollment_date;
            
            // MOSTRAR NOMBRE DEL ALUMNO (SOLO LECTURA)
            document.getElementById('studentSelect').innerHTML = `<option value="${enrollment.student_id}" selected>${enrollment.student_name} (EDITANDO)</option>`;
            document.getElementById('studentSelect').disabled = true;
            
            // Cambiar a modo edici√≥n
            isEditingEnrollment = true;
            currentEnrollmentId = enrollmentId;
            document.getElementById('enrollmentFormTitle').textContent = '‚úèÔ∏è Editar Matr√≠cula';
            document.getElementById('submitEnrollmentButton').textContent = 'üíæ Actualizar Matr√≠cula';
            document.getElementById('cancelButton').style.display = 'inline-block';
            
            // Cargar todas las aulas (no solo disponibles)
            await loadAllClassrooms();
            
            // Seleccionar el aula actual
            setTimeout(() => {
                document.getElementById('classroomSelect').value = enrollment.classroom_id;
            }, 100);
            
        } else {
            alert('‚ùå Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al cargar datos de la matr√≠cula para editar');
    }
}

        // Cancelar edici√≥n
function cancelEdit() {
    isEditingEnrollment = false;
    currentEnrollmentId = null;
    document.getElementById('enrollmentFormTitle').textContent = 'üéì Nueva Matr√≠cula';
    document.getElementById('submitEnrollmentButton').textContent = '‚úÖ Registrar Matr√≠cula';
    document.getElementById('cancelButton').style.display = 'none';
    document.getElementById('enrollmentForm').reset();
    
    // HABILITAR SELECT DE ESTUDIANTES NUEVAMENTE
    document.getElementById('studentSelect').disabled = false;
    
    loadUnenrolledStudents();
    loadAvailableClassrooms();
}

        // Anular matr√≠cula
        async function cancelEnrollment(enrollmentId) {
            if (confirm('¬øEst√°s seguro de que deseas anular esta matr√≠cula? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const response = await fetch(`/api/enrollments/${enrollmentId}/cancel`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            status: 'inactive'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Matr√≠cula anulada correctamente');
                        loadEnrollments();
                        loadUnenrolledStudents();
                        loadAvailableClassrooms();
                    } else {
                        alert('‚ùå Error: ' + result.error);
                    }
                } catch (error) {
                    alert('‚ùå Error al anular matr√≠cula');
                }
            }
        }

        // Generar constancia (ya existente)
        async function generateCertificate(enrollmentId) {
            try {
                const response = await fetch(`/api/enrollments/${enrollmentId}/certificate`);
                const result = await response.json();
                
                if (result.success) {
                    const cert = result.certificate;
                    
                    const params = new URLSearchParams({
                        student_name: cert.student_name,
                        student_dni: cert.student_dni,
                        student_birth_date: cert.student_birth_date,
                        classroom_name: cert.classroom_name,
                        classroom_age_range: cert.classroom_age_range,
                        enrollment_date: cert.enrollment_date,
                        enrollment_id: cert.enrollment_id,
                        current_date: cert.current_date
                    });
                    
                    window.open(
                        `/certificado-matricula?${params}`,
                        '_blank',
                        'width=900,height=700,scrollbars=yes'
                    );
                    
                } else {
                    alert('Error al generar constancia: ' + result.error);
                }
            } catch (error) {
                alert('Error al generar la constancia');
            }
        }

        // Enviar formulario (crear o editar)
        document.getElementById('enrollmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentSelect').value;
            const classroomId = document.getElementById('classroomSelect').value;
            const enrollmentDate = document.getElementById('enrollmentDate').value;
            const enrollmentId = document.getElementById('enrollmentId').value;

            if (!classroomId || !enrollmentDate) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }

            try {
                let url, method, body;

                if (isEditingEnrollment && enrollmentId) {
                    // Modo edici√≥n
                    url = `/api/enrollments/${enrollmentId}/update`;
                    method = 'PUT';
                    body = {
                        classroom_id: parseInt(classroomId),
                        enrollment_date: enrollmentDate
                    };
                } else {
                    // Modo creaci√≥n
                    if (!studentId) {
                        alert('Por favor seleccione un estudiante');
                        return;
                    }
                    url = '/api/enrollments';
                    method = 'POST';
                    body = {
                        student_id: parseInt(studentId),
                        classroom_id: parseInt(classroomId),
                        enrollment_date: enrollmentDate
                    };
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Matr√≠cula ${isEditingEnrollment ? 'actualizada' : 'registrada'} exitosamente`);
                    cancelEdit(); // Resetear formulario
                    loadEnrollments();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const localDate = today.toISOString().split('T')[0];
            document.getElementById('enrollmentDate').valueAsDate = new Date();
            loadUnenrolledStudents();
            loadAvailableClassrooms();
            loadEnrollments();
        });

        // Hacer funciones globales
        window.viewEnrollment = viewEnrollment;
        window.editEnrollment = editEnrollment;
        window.cancelEnrollment = cancelEnrollment;
        window.generateCertificate = generateCertificate;
        window.cancelEdit = cancelEdit;
    </script>
</body>
</html>