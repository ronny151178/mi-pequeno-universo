<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - Mi Pequeño Universo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
            <span>Mi Pequeño Universo</span>
        </div>
        <div class="user-menu">Administrador 👤</div>
    </div>
    
    <div class="main-grid">
        <div class="sidebar">
            <a href="/dashboard">📊 Dashboard</a>
            <a href="/config-año">📅 Año Escolar</a>
            <a href="/config-aulas">🏫 Aulas</a>
            <a href="/config-conceptos">💰 Conceptos</a>
            <a href="/estudiantes">👥 Estudiantes</a>
            <a href="/matriculas">🎓 Matrículas</a>
            <a href="/pagos">💳 Pagos</a>
            <a href="/planes-pago">📅 Planes de Pago</a>
            <a href="/almacen">📦 Almacén</a>
            <a href="/reportes" class="active">📊 Reportes</a>
            <a href="/api/logout">🚪 Salir</a>
        </div>
        
        <div class="content">
            <div class="card">
                <h1>📊 Reportes del Sistema</h1>
                <p>Genera reportes automáticos de toda la información</p>
            </div>

            <!-- SELECTOR DE REPORTES -->
            <div class="card">
                <h2>🎯 Seleccionar Reporte</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reporteSelect">Tipo de Reporte</label>
                        <select id="reporteSelect" class="form-control" onchange="cambiarReporte()">
                            <option value="">Seleccionar reporte...</option>
                            <option value="estudiantes-aula">📋 Lista de Estudiantes por Aula</option>
                            <option value="cuotas-vencidas">💰 Cuotas Vencidas por Alumno</option>
                            <option value="stock-bajo">📦 Materiales con Stock Bajo</option>
                            <option value="resumen-matriculas">🎓 Resumen de Matrículas</option>
                            <option value="utiles-pendientes">📚 Útiles Pendientes por Aula</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="filtroAulaContainer" style="display: none;">
                        <label for="filtroAula">Filtrar por Aula</label>
                        <select id="filtroAula" class="form-control">
                            <option value="">Todas las aulas</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="generarReporte()">📊 Generar Reporte</button>
                    <button class="btn btn-success" onclick="imprimirReporte()" id="btnImprimir" style="display: none;">🖨️ Imprimir</button>
                </div>
            </div>

            <!-- RESULTADOS DEL REPORTE -->
            <div class="card" id="resultadosReporte" style="display: none;">
                <h2 id="tituloReporte">Resultados del Reporte</h2>
                <div id="contenidoReporte">
                    <!-- Aquí se cargarán los resultados -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let reporteActual = '';
        let datosReporte = null;

        // Cargar aulas para filtros
        async function cargarAulas() {
            try {
                const response = await fetch('/api/classrooms');
                const aulas = await response.json();
                
                const select = document.getElementById('filtroAula');
                select.innerHTML = '<option value="">Todas las aulas</option>';
                
                aulas.forEach(aula => {
                    const option = document.createElement('option');
                    option.value = aula.id;
                    option.textContent = aula.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando aulas:', error);
            }
        }

        // Cambiar tipo de reporte
        function cambiarReporte() {
            reporteActual = document.getElementById('reporteSelect').value;
            const filtroContainer = document.getElementById('filtroAulaContainer');
            
            // Mostrar filtro de aula solo para reportes que lo necesitan
            if (reporteActual === 'estudiantes-aula' || reporteActual === 'utiles-pendientes') {
                filtroContainer.style.display = 'block';
            } else {
                filtroContainer.style.display = 'none';
            }
            
            // Ocultar resultados anteriores
            document.getElementById('resultadosReporte').style.display = 'none';
            document.getElementById('btnImprimir').style.display = 'none';
        }

        // Generar reporte
        async function generarReporte() {
            if (!reporteActual) {
                alert('❌ Selecciona un tipo de reporte');
                return;
            }

            try {
                let url = '';
                const aulaId = document.getElementById('filtroAula').value;
                
                // Construir URL según el reporte
                switch(reporteActual) {
                    case 'estudiantes-aula':
                        url = '/api/reportes/estudiantes-por-aula';
                        if (aulaId) url += `?aula_id=${aulaId}`;
                        break;
                    case 'cuotas-vencidas':
                        url = '/api/reportes/cuotas-vencidas';
                        break;
                    case 'stock-bajo':
                        url = '/api/reportes/stock-bajo';
                        break;
                    case 'resumen-matriculas':
                        url = '/api/reportes/resumen-matriculas';
                        break;
                    case 'utiles-pendientes':
                        url = '/api/reportes/utiles-pendientes';
                        if (aulaId) url += `?aula_id=${aulaId}`;
                        break;
                }

                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    datosReporte = result;
                    mostrarResultados(result);
                    document.getElementById('btnImprimir').style.display = 'inline-block';
                } else {
                    alert('❌ Error: ' + result.error);
                }
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                alert('❌ Error al generar el reporte');
            }
        }

        // Mostrar resultados del reporte
        function mostrarResultados(data) {
            const contenedor = document.getElementById('contenidoReporte');
            let html = '';
            
            switch(reporteActual) {
                case 'estudiantes-aula':
                    html = generarHTMLEstudiantesAula(data);
                    break;
                case 'cuotas-vencidas':
                    html = generarHTMLCuotasVencidas(data);
                    break;
                case 'stock-bajo':
                    html = generarHTMLStockBajo(data);
                    break;
                case 'resumen-matriculas':
                    html = generarHTMLResumenMatriculas(data);
                    break;
                case 'utiles-pendientes':
                    html = generarHTMLUtilesPendientes(data);
                    break;
            }
            
            // Actualizar título
            const titulos = {
                'estudiantes-aula': '📋 Lista de Estudiantes por Aula',
                'cuotas-vencidas': '💰 Cuotas Vencidas por Alumno', 
                'stock-bajo': '📦 Materiales con Stock Bajo',
                'resumen-matriculas': '🎓 Resumen de Matrículas',
                'utiles-pendientes': '📚 Útiles Pendientes por Aula'
            };
            document.getElementById('tituloReporte').textContent = titulos[reporteActual];
            
            contenedor.innerHTML = html;
            document.getElementById('resultadosReporte').style.display = 'block';
        }

        // Generadores de HTML para cada reporte
        function generarHTMLEstudiantesAula(data) {
            let html = `<div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>DNI</th>
                            <th>Edad</th>
                            <th>Teléfono</th>
                            <th>Aula</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.data.forEach(est => {
                html += `
                    <tr>
                        <td><strong>${est.nombre_completo}</strong></td>
                        <td>${est.dni}</td>
                        <td>${est.edad} años</td>
                        <td>${est.telefono}</td>
                        <td>${est.aula}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>
                <div class="resumen" style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <strong>Total de estudiantes:</strong> ${data.data.length}
                </div>
            </div>`;
            
            return html;
        }

        function generarHTMLCuotasVencidas(data) {
            let html = `<div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Alumno</th>
                            <th>DNI</th>
                            <th>Aula</th>
                            <th>Concepto</th>
                            <th>Cuota #</th>
                            <th>Monto</th>
                            <th>Vencimiento</th>
                            <th>Días Mora</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.data.forEach(cuota => {
                html += `
                    <tr>
                        <td><strong>${cuota.alumno_nombre}</strong></td>
                        <td>${cuota.alumno_dni}</td>
                        <td>${cuota.aula}</td>
                        <td>${cuota.concepto}</td>
                        <td>${cuota.cuota_numero}</td>
                        <td>S/ ${cuota.monto}</td>
                        <td>${cuota.fecha_vencimiento}</td>
                        <td><span style="color: red; font-weight: bold;">${cuota.dias_mora} días</span></td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>
                <div class="resumen" style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                    <strong>Resumen:</strong> ${data.total_cuotas} cuotas vencidas | 
                    <strong>Total adeudado:</strong> S/ ${data.total_adeudado} |
                    <strong>Alumnos con mora:</strong> ${new Set(data.data.map(c => c.alumno_id)).size}
                </div>
            </div>`;
            
            return html;
        }

        function generarHTMLStockBajo(data) {
            let html = `<div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Categoría</th>
                            <th>Stock Actual</th>
                            <th>Stock Mínimo</th>
                            <th>Faltante</th>
                            <th>Estado</th>
                            <th>Ubicación</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.data.forEach(material => {
                const colorEstado = material.estado === 'CRÍTICO' ? 'red' : 'orange';
                html += `
                    <tr>
                        <td><strong>${material.nombre}</strong></td>
                        <td>${material.categoria}</td>
                        <td>${material.stock_actual} ${material.unidad_medida}</td>
                        <td>${material.stock_minimo} ${material.unidad_medida}</td>
                        <td>${material.diferencia} ${material.unidad_medida}</td>
                        <td><span style="color: ${colorEstado}; font-weight: bold;">${material.estado}</span></td>
                        <td>${material.ubicacion}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>
                <div class="resumen" style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                    <strong>Total de materiales con stock bajo:</strong> ${data.data.length}
                </div>
            </div>`;
            
            return html;
        }

        function generarHTMLResumenMatriculas(data) {
            let html = `<div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Aula</th>
                            <th>Rango Edad</th>
                            <th>Capacidad</th>
                            <th>Matriculados</th>
                            <th>Cupos Disponibles</th>
                            <th>Ocupación</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.data.forEach(aula => {
                const colorOcupacion = aula.porcentaje_ocupacion > 90 ? 'red' : 
                                     aula.porcentaje_ocupacion > 70 ? 'orange' : 'green';
                html += `
                    <tr>
                        <td><strong>${aula.aula_nombre}</strong></td>
                        <td>${aula.edad_rango}</td>
                        <td>${aula.capacidad}</td>
                        <td>${aula.matriculados}</td>
                        <td>${aula.cupos_disponibles}</td>
                        <td><span style="color: ${colorOcupacion}; font-weight: bold;">${aula.porcentaje_ocupacion}%</span></td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>
                <div class="resumen" style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <strong>Resumen General:</strong> 
                    ${data.totales.total_matriculados} estudiantes en ${data.totales.total_aulas} aulas | 
                    Ocupación total: ${data.totales.porcentaje_total}% |
                    Cupos disponibles: ${data.totales.total_capacidad - data.totales.total_matriculados}
                </div>
            </div>`;
            
            return html;
        }

        function generarHTMLUtilesPendientes(data) {
            let html = '';
            
            data.data.forEach(aula => {
                html += `<div class="aula-section" style="margin-bottom: 30px; padding: 20px; border: 2px solid #e2e8f0; border-radius: 10px;">
                    <h3 style="color: #2563eb; margin-bottom: 15px;">🏫 ${aula.aula_nombre}</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Cantidad Requerida</th>
                                    <th>Total Pendiente</th>
                                    <th>Estudiantes con Faltantes</th>
                                    <th>Especificaciones</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                aula.utiles.forEach(util => {
                    html += `
                        <tr>
                            <td><strong>${util.material}</strong></td>
                            <td>${util.cantidad_requerida}</td>
                            <td><span style="color: red; font-weight: bold;">${util.total_pendiente}</span></td>
                            <td>${util.estudiantes_con_faltantes}</td>
                            <td>${util.especificaciones}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div></div>`;
            });
            
            if (data.data.length === 0) {
                html = `<div class="empty-state">
                    <div class="icon">✅</div>
                    <p>No hay útiles pendientes en las aulas seleccionadas</p>
                </div>`;
            }
            
            return html;
        }

        // Imprimir reporte
        function imprimirReporte() {
            if (!datosReporte) {
                alert('❌ Primero genera un reporte');
                return;
            }

            const ventanaImpresion = window.open('', '_blank', 'width=1000,height=700');
            const titulo = document.getElementById('tituloReporte').textContent;
            
            let contenidoHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${titulo} - Mi Pequeño Universo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header h1 { color: #2563eb; margin: 0; }
                        .header h2 { color: #666; margin: 5px 0 0 0; font-weight: normal; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .resumen { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
                        @media print { body { margin: 10px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${titulo}</h1>
                        <h2>Mi Pequeño Universo - ${new Date().toLocaleDateString()}</h2>
                    </div>
                    ${document.getElementById('contenidoReporte').innerHTML}
                    <div style="margin-top: 30px; text-align: right; color: #666; font-style: italic;">
                        Generado el: ${new Date().toLocaleString()}
                    </div>
                </body>
                </html>
            `;

            ventanaImpresion.document.write(contenidoHTML);
            ventanaImpresion.document.close();
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            cargarAulas();
        });
    </script>
</body>
</html>